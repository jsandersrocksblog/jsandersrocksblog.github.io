---
id: 803
title: WinInet used in Thread Impersonation
date: 2009-07-09T15:48:00-05:00
author: jsanders
layout: post
guid: http://jsandersblog.azurewebsites.net/2009/07/09/wininet-used-in-thread-impersonation/
permalink: /2009/07/09/wininet-used-in-thread-impersonation/
orig_url:
  - http://blogs.msdn.microsoft.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.microsoft.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.microsoft.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.microsoft.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.microsoft.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.microsoft.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.microsoft.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.microsoft.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.microsoft.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.microsoft.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
orig_site_id:
  - "8394"
  - "8394"
  - "8394"
  - "8394"
  - "8394"
  - "8394"
  - "8394"
  - "8394"
  - "8394"
  - "8394"
orig_post_id:
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
orig_parent_id:
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
  - "9827561"
orig_thread_id:
  - "665727"
  - "665727"
  - "665727"
  - "665727"
  - "665727"
  - "665727"
  - "665727"
  - "665727"
  - "665727"
  - "665727"
orig_application_key:
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
orig_post_author_id:
  - "65385"
  - "65385"
  - "65385"
  - "65385"
  - "65385"
  - "65385"
  - "65385"
  - "65385"
  - "65385"
  - "65385"
orig_post_author_username:
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
  - jpsanders
orig_post_author_created:
  - Jan 18 2007 01:34:53:000PM
  - Jan 18 2007 01:34:53:000PM
  - Jan 18 2007 01:34:53:000PM
  - Jan 18 2007 01:34:53:000PM
  - Jan 18 2007 01:34:53:000PM
  - Jan 18 2007 01:34:53:000PM
  - Jan 18 2007 01:34:53:000PM
  - Jan 18 2007 01:34:53:000PM
  - Jan 18 2007 01:34:53:000PM
  - Jan 18 2007 01:34:53:000PM
orig_is_approved:
  - "1"
  - "1"
  - "1"
  - "1"
  - "1"
  - "1"
  - "1"
  - "1"
  - "1"
  - "1"
orig_attachment_count:
  - "0"
  - "0"
  - "0"
  - "0"
  - "0"
  - "0"
  - "0"
  - "0"
  - "0"
  - "0"
orig_url_title:
  - http://blogs.msdn.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
  - http://blogs.msdn.com/b/jpsanders/archive/2009/07/09/wininet-used-in-thread-impersonation.aspx
opengraph_tags:
  - |
    <meta property="og:type" content="article" />
    <meta property="og:title" content="WinInet used in Thread Impersonation" />
    <meta property="og:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta property="og:site_name" content="Http Client Protocol Issues (and other fun stuff I support)" />
    <meta property="og:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="WinInet used in Thread Impersonation" />
    <meta name="twitter:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta name="twitter:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    
  - |
    <meta property="og:type" content="article" />
    <meta property="og:title" content="WinInet used in Thread Impersonation" />
    <meta property="og:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta property="og:site_name" content="Http Client Protocol Issues (and other fun stuff I support)" />
    <meta property="og:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="WinInet used in Thread Impersonation" />
    <meta name="twitter:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta name="twitter:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    
  - |
    <meta property="og:type" content="article" />
    <meta property="og:title" content="WinInet used in Thread Impersonation" />
    <meta property="og:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta property="og:site_name" content="Http Client Protocol Issues (and other fun stuff I support)" />
    <meta property="og:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="WinInet used in Thread Impersonation" />
    <meta name="twitter:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta name="twitter:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    
  - |
    <meta property="og:type" content="article" />
    <meta property="og:title" content="WinInet used in Thread Impersonation" />
    <meta property="og:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta property="og:site_name" content="Http Client Protocol Issues (and other fun stuff I support)" />
    <meta property="og:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="WinInet used in Thread Impersonation" />
    <meta name="twitter:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta name="twitter:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    
  - |
    <meta property="og:type" content="article" />
    <meta property="og:title" content="WinInet used in Thread Impersonation" />
    <meta property="og:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta property="og:site_name" content="Http Client Protocol Issues (and other fun stuff I support)" />
    <meta property="og:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="WinInet used in Thread Impersonation" />
    <meta name="twitter:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta name="twitter:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    
  - |
    <meta property="og:type" content="article" />
    <meta property="og:title" content="WinInet used in Thread Impersonation" />
    <meta property="og:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta property="og:site_name" content="Http Client Protocol Issues (and other fun stuff I support)" />
    <meta property="og:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="WinInet used in Thread Impersonation" />
    <meta name="twitter:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta name="twitter:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    
  - |
    <meta property="og:type" content="article" />
    <meta property="og:title" content="WinInet used in Thread Impersonation" />
    <meta property="og:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta property="og:site_name" content="Http Client Protocol Issues (and other fun stuff I support)" />
    <meta property="og:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="WinInet used in Thread Impersonation" />
    <meta name="twitter:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta name="twitter:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    
  - |
    <meta property="og:type" content="article" />
    <meta property="og:title" content="WinInet used in Thread Impersonation" />
    <meta property="og:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta property="og:site_name" content="Http Client Protocol Issues (and other fun stuff I support)" />
    <meta property="og:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="WinInet used in Thread Impersonation" />
    <meta name="twitter:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta name="twitter:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    
  - |
    <meta property="og:type" content="article" />
    <meta property="og:title" content="WinInet used in Thread Impersonation" />
    <meta property="og:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta property="og:site_name" content="Http Client Protocol Issues (and other fun stuff I support)" />
    <meta property="og:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="WinInet used in Thread Impersonation" />
    <meta name="twitter:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta name="twitter:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    
  - |
    <meta property="og:type" content="article" />
    <meta property="og:title" content="WinInet used in Thread Impersonation" />
    <meta property="og:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta property="og:site_name" content="Http Client Protocol Issues (and other fun stuff I support)" />
    <meta property="og:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="WinInet used in Thread Impersonation" />
    <meta name="twitter:url" content="https://blogs.msdn.microsoft.com/jpsanders/2009/07/09/wininet-used-in-thread-impersonation/" />
    <meta name="twitter:description" content="First and foremost, this is NOT supported for reasons stated in this article: http://support.microsoft.com/default.aspx/kb/238425. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally,..." />
    
categories:
  - Uncategorized
tags:
  - WinInet
---
 <font color="#000000" size="2"></p> 

<p>
  First and foremost, this is NOT supported for reasons stated in this article: <a href="http://support.microsoft.com/default.aspx/kb/238425">http://support.microsoft.com/default.aspx/kb/238425</a>. Primarily, problems occur because of information that is stored in the HKEY_CURRENT_USERS registry key and because of threading concerns.&nbsp; Furthermore, due to security implications and the design of WinInet in Windows 7, this absolutely will not work in Windows 7.&nbsp; Finally, in Vista, there is a Low IL cache as well as the normal (Medium IL) cache so this sample is ineffective at best.&nbsp; This blog entry is mearly an excercise to help you understand how the Registry works with thread impersonation as I discovered when working on a WinInet problem.
</p>

<p>
  That said, if you have a service running in the Local System Account, you might be able to work around some of the problems by ensuring the registry is loaded with the currently logged on user&#8217;s registry information.&nbsp; If the currently logged on user has used the browser, most information should be populated in that user&#8217;s registry.
</p>

<p>
  If running with UAC enabled and you attempt to enumerate the cache while running under the Local System account you will fail and GetLastError will return ERROR_INVALID_PARAMETER. This error is thrown because internally there are some registry settings missing that WinInet expects to be there for every user (again, WinInet is not designed, tested or supported when running under the System Account or when using thread impersonation).&nbsp; I found however if you use thread impersonation and load the registry HKCU for the currently logged on user, you can access the cache.&nbsp; I do not know if this will work in all scenarios and in future WinInet releases, but I was able to get it to work for me.&nbsp; I used PsExec from Sysinternals to run my tests.
</p>

<p>
  <strong>Details<br /></strong>I downloaded and installed PsExec from <a href="http://technet.microsoft.com/en-us/sysinternals/bb896649.aspx" mce_href="http://technet.microsoft.com/en-us/sysinternals/bb896649.aspx">http://technet.microsoft.com/en-us/sysinternals/bb896649.aspx</a>
</p>

<p>
  I created a new C++ Console application in Visual Studio and added code to:<br />1. Get the Currently Logged on user token in the SessionID from where this program was launched under the SYSTEM account using WTSQueryUserToken<br />2. Impersonate this user using ImpersonateLoggedOnUser<br />3. Load the impersonated HKU registry in HKCU by using RegDisablePredefinedCache<br />4. Iterate through the IE cache using FindFirstUrlCacheEntry and FindNextUrlCacheEntry<br />5. I added code that would also show the cache if the WTSQueryUserToken failed.&nbsp; This will fail if you are running the program from the command line (no PsExec).&nbsp; This allows you to see the case running in the context of the current user.&nbsp;
</p>

<p>
  I then added the WinInet.lib and Wtsapi32.lib to the linker input files and built the project.
</p>

<p>
  I then tested the code with PsExec using: PsExec –i –s <<full path and program name>>.&nbsp; I opened a command prompt with Administrator permissions to run the tests.&nbsp; An interesting use of PsExec allows you to see the cache when running as an Low IL process:&nbsp; PsExec –l <<full path and program name>>.&nbsp; Note that this is a different set of values because the Low IL cache is in a different location then the Medium (normal) IL cache.<br />For details on protected mode cache see: <a href="http://blogs.msdn.com/ie/archive/2006/02/09/528963.aspx" mce_href="http://blogs.msdn.com/ie/archive/2006/02/09/528963.aspx">http://blogs.msdn.com/ie/archive/2006/02/09/528963.aspx</a>
</p>

<p>
  Here is the code for your enjoyment.&nbsp; Of course you would need to add your code to test the success of calls, trap exceptions etc&#8230;&nbsp; But it should get you started:
</p>

<p>
  <strong>C++ code listing for sample (<a href="javascript:CopyCode('WinInetImpersonate1');">Copy Code</a>):</strong>
</p>

<div style="background-color: #e0e0e0" id="WinInetImpersonate1">
  <p>
    <font color="#008000" size="2">// ImpersonateWinInet.cpp : Defines the entry point for the console application.<br />// </font>
  </p>
  
  <p>
    <font color="#0000ff" size="2">#include </font><font color="#a31515" size="2">&#8220;stdafx.h&#8221;</font><br /><font color="#0000ff" size="2"><font color="#0000ff" size="2">#include</font></font><font size="2"> </font><font color="#a31515" size="2"><font color="#a31515" size="2"><windows.h><br /></font></font><font color="#0000ff" size="2"><font color="#0000ff" size="2">#include</font></font><font size="2"> </font><font color="#a31515" size="2"><font color="#a31515" size="2"><WinInet.h><br /></font></font><font color="#0000ff" size="2"><font color="#0000ff" size="2">#pragma</font></font><font size="2"> </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">comment</font></font><font size="2">(</font><font color="#0000ff" size="2"><font color="#0000ff" size="2">lib</font></font><font size="2">, </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;WinInet.lib&#8221;</font></font><font size="2">)<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2">#include</font></font><font size="2"> </font><font color="#a31515" size="2"><font color="#a31515" size="2"><Wtsapi32.h><br /></font></font><font color="#0000ff" size="2"><font color="#0000ff" size="2">#pragma</font></font><font size="2"> </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">comment</font></font><font size="2">(</font><font color="#0000ff" size="2"><font color="#0000ff" size="2">lib</font></font><font size="2">, </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;Wtsapi32.lib&#8221;</font></font><font size="2">)<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2">#include</font></font><font size="2"> </font><font color="#a31515" size="2"><font color="#a31515" size="2"><iostream><br /></font></font><font color="#0000ff" size="2"><font color="#0000ff" size="2">#include</font></font><font size="2"> </font><font color="#a31515" size="2"><font color="#a31515" size="2"><conio.h></font></font><font size="2"> </font><font color="#008000" size="2"><font color="#008000" size="2">// for _getch<br /></font></font><font color="#0000ff" size="2"><font color="#0000ff" size="2">int</font></font><font size="2"> showCache()<br /></font><font size="2">{<br /></font><font color="#008000" size="2"><font color="#008000" size="2">&nbsp;&nbsp;&nbsp; // another gotcha&#8230; The actual cache hit here depends on the IL that the program is running under.<br /></font></font><font size="2"></font><font color="#008000" size="2"><font color="#008000" size="2">&nbsp;&nbsp;&nbsp; // to see this run psexec with the -l option in a cmd prompt<br /></font></font><font size="2"></font><font size="2"><font color="#008000" size="2">&nbsp;&nbsp;&nbsp; // Local variables<br /></font></font><font size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>DWORD cacheEntryInfoBufferSizeInitial = 0;<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>DWORD cacheEntryInfoBufferSize = 0;<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>int</font></font><font size="2"> *cacheEntryInfoBuffer = 0;<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>INTERNET_CACHE_ENTRY_INFO *internetCacheEntry;<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>HANDLE enumHandle = NULL;<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>BOOL returnValue = </font><font color="#0000ff" size="2"><font color="#0000ff" size="2">false</font></font><font size="2">;<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>int</font></font><font size="2"> aiNumEntries=0;<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>DWORD dwError;<br /></font><font size="2"><font color="#008000" size="2">&nbsp;&nbsp;&nbsp; // get the size of the buffer required<br /></font></font><font size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>enumHandle = FindFirstUrlCacheEn<br /> try(NULL, 0, &cacheEntryInfoBufferSizeInitial);<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>if</font></font><font size="2"> (enumHandle == NULL && ERROR_NO_MORE_ITEMS == GetLastError())<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>{<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>return</font></font><font size="2"> aiNumEntries;<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>}<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>cacheEntryInfoBufferSize = cacheEntryInfoBufferSizeInitial;<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>internetCacheEntry = (INTERNET_CACHE_ENTRY_INFO *)malloc(cacheEntryInfoBufferSize);<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>enumHandle = FindFirstUrlCacheEntry(NULL, internetCacheEntry, &cacheEntryInfoBufferSizeInitial);<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>if</font></font><font size="2"> (enumHandle == NULL)<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>{<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>std::cout << </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;could not get first URL entry. Error :&#8221;</font></font><font size="2"> << GetLastError();<br /></font><font color="#008000" size="2"><font color="#008000" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // ERROR_INVALID_PARAMETER is thrown because of incorrect registry info<br /></font></font><font size="2"></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>return</font></font><font size="2"> aiNumEntries;<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>}<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>returnValue=</font><font color="#0000ff" size="2"><font color="#0000ff" size="2">true</font></font><font size="2">;<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>while</font></font><font size="2">(1)<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>{<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>cacheEntryInfoBufferSizeInitial = cacheEntryInfoBufferSize; <br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>if</font></font><font size="2"> (returnValue)<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>{<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>if</font></font><font size="2"> (internetCacheEntry != NULL)<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>{<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>std::wcout<<(LPWSTR)((INTERNET_CACHE_ENTRY_INFO *)internetCacheEntry->lpszSourceUrlName)<< _T(</font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;\r\n&#8221;</font></font><font size="2">);<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>returnValue = FindNextUrlCacheEntry(enumHandle, internetCacheEntry, &cacheEntryInfoBufferSizeInitial);<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>aiNumEntries++;<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>}<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>else<br /></font></font><font size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>{<br /></font><font color="#008000" size="2"><font color="#008000" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // this should not happen!<br /></font></font><font size="2"></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>break</font></font><font size="2">;<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>}<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>}</p> 
    
    <p>
      <font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>dwError = GetLastError();<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>if</font></font><font size="2"> (!returnValue && ERROR_NO_MORE_ITEMS == dwError)<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>break</font></font><font size="2">; </font><font color="#008000" size="2"><font color="#008000" size="2">//now more items!<br /></font></font><font size="2"></p> 
      
      <p>
        </font><font color="#008000" size="2"><font color="#008000" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // if buffer not big enough, grow it <br /></font></font><font size="2"></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>if</font></font><font size="2"> (!returnValue && cacheEntryInfoBufferSizeInitial > cacheEntryInfoBufferSize)<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>{<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>cacheEntryInfoBufferSize = cacheEntryInfoBufferSizeInitial;<br /></font><font size="2"><font color="#008000" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // note test for buffer here (OOM condition)<br /></font></font><font size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>internetCacheEntry = (INTERNET_CACHE_ENTRY_INFO *)realloc(internetCacheEntry, cacheEntryInfoBufferSize);<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>returnValue = FindNextUrlCacheEntry(enumHandle, internetCacheEntry, &cacheEntryInfoBufferSizeInitial); <br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>}<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>}<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>free(internetCacheEntry);<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>std::wcout<<_T(</font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;Number of entries processed: &#8220;</font></font><font size="2">)<<aiNumEntries<<_T(</font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;\r\n&#8221;</font></font><font size="2">);<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>return</font></font><font size="2"> aiNumEntries;<br />}</p> <p mce_keep="true"></font><font color="#0000ff" size="2"><font color="#0000ff" size="2">int</font></font><font size="2"> _tmain(</font><font color="#0000ff" size="2"><font color="#0000ff" size="2">int</font></font><font size="2"> argc, _TCHAR* argv[])<br />{<br /></font><font size="2"><font color="#008000" size="2">&nbsp;&nbsp;&nbsp; // note, this below will get the session id that this program was run from.<br /></font></font><font size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>DWORD dwActiveSessionId = WTS_CURRENT_SESSION;<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>HANDLE hUserToken = INVALID_HANDLE_VALUE;<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>DWORD dwErr=0;</p> 
        
        <p>
          </font><font size="2"><font color="#00800
0" size="2">&nbsp;&nbsp;&nbsp; //showCache();<br /></font></font><font size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>BOOL bSuccess = WTSQueryUserToken(dwActiveSessionId, &hUserToken);<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>if</font></font><font size="2"> (bSuccess)<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>{<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>std::cout << </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;Got User Token\r\n&#8221;</font></font><font size="2">;<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>bSuccess = ::ImpersonateLoggedOnUser(hUserToken);<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>if</font></font><font size="2"> (bSuccess)<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>{<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>std::cout << </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;Impersonating\r\n&#8221;</font></font><font size="2">;<br /></font><font color="#008000" size="2"><font color="#008000" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // This is necessary because we want to load the impersonated user registry into HKCU<br /></font></font><font size="2"></font><font size="2"><font color="#008000" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // comment this out whey running under the system acct and you will get ERROR_INVALID_PARAMETER<br /></font></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>if</font></font><font size="2">( ERROR_SUCCESS==RegDisablePredefinedCache())<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>{<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>showCache();<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>}<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>CloseHandle(hUserToken);<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>}<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>else<br /></font></font><font size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>{<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>std::cout << </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;Failed Impersonation\r\n&#8221;</font></font><font size="2">;<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>}<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>}<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>else<br /></font></font><font size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>{<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>std::cout << </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;Did not Get User Token\r\n&#8221;</font></font><font size="2">;<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>dwErr= ::GetLastError();<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>std::cout << </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;Error&#8221;</font></font><font size="2"> << dwErr << </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;\r\n&#8221;</font></font><font size="2">;<br /></font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>if</font></font><font size="2"> (ERROR_PRIVILEGE_NOT_HELD==dwErr)<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>{<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>std::cout << </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;To call WTSQueryUserToken successfully, the calling application must be running within the context of the LocalSystem account and have the SE_TCB_NAME privilege\r\n&#8221;</font></font><font size="2">;<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>std::cout << </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;Trying in the context of the user running this program&#8230;\r\n&#8221;</font></font><font size="2">;<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>std::cout << </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;Hit a key or enter to start&#8221;</font></font><font size="2">;<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>_getch();<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>showCache();<br /><font color="#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font>}<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>}</p> 
          
          <p>
            <font color="#008000">&nbsp;&nbsp;&nbsp; </font>std::cout<< </font><font color="#a31515" size="2"><font color="#a31515" size="2">&#8220;Hit a key or enter to exit&#8221;</font></font><font size="2">;<br /><font color="#008000">&nbsp;&nbsp;&nbsp; </font>_getch();</p> 
            
            <p>
              </font><font color="#0000ff" size="2"><font color="#0000ff" size="2"><font color="#008000">&nbsp;&nbsp;&nbsp; </font>return</font></font><font size="2"> 0;<br />}</font>
            </p>
            
            <p>
              <font size="2"></font>&nbsp;
            </p></div> 
            
            <p>
              <font size="2"></font><font size="2">I hope this sample helps you out.&nbsp; Please drop me a comment if you found this useful!</p> 
              
              <p>
                </font>
              </p>